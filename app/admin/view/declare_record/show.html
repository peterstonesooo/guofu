<!-- Main content -->
<section class="content">
<div class="row">
<div class="col-xs-12">
<div class="box box-primary">
    <div class="box-header with-border">
        <h3 class="box-title">申报记录详情 #{$data.id}</h3>
        <div class="box-tools pull-right">
            <a href="{:url('admin/DeclareRecord/index')}" class="btn btn-sm btn-default">
                <i class="fa fa-list"></i> 返回列表
            </a>
        </div>
    </div>
    <!-- /.box-header -->
<div class="box-body">
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label>用户名称：</label>
                <p class="form-control-static">{$data.user_name}</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label>补贴名称：</label>
                <p class="form-control-static">{$data.subsidy_name}</p>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label>补贴类型：</label>
                <p class="form-control-static">{$data.type_name}</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label>申报金额：</label>
                <p class="form-control-static">¥{$data.declare_amount}</p>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label>申报周期：</label>
                    <p class="form-control-static">{$data.declare_cycle}天</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label>申报时间：</label>
                <p class="form-control-static">{$data.created_at}</p>
            </div>
        </div>
    </div>

<div class="row">
<div class="col-md-6">
<div class="form-group">
    <label>状态：</label>
<p class="form-control-static">
{if $data.status == 0}
    <span class="label label-warning">待审核</span>
{elseif $data.status == 1}
    <span class="label label-success">审核通过</span>
{else}
    <span class="label label-danger">审核不通过</span>
{/if}
</p>
</div>
</div>
{if $data.status != 0}
    <div class="col-md-6">
        <div class="form-group">
            <label>审核时间：</label>
            <p class="form-control-static">{$data.audit_time}</p>
        </div>
    </div>
{/if}
</div>

{if $data.status != 0}
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label>审核人：</label>
                <p class="form-control-static">{$data.audit_user_name}</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label>审核备注：</label>
                <p class="form-control-static">{$data.audit_remark|default='无'}</p>
            </div>
        </div>
    </div>
{/if}

    <div class="form-group">
        <label>补贴描述：</label>
        <div class="form-control-static"
             style="border: 1px solid #eee; padding: 10px; border-radius: 4px;">
            {$data.description|raw}
        </div>
    </div>

    <!-- 资金明细 -->
<div class="form-group">
    <label>资金明细：</label>
<div class="table-responsive">
<table class="table table-bordered table-striped">
    <thead>
    <tr>
        <th>资金类型</th>
        <th>补贴金额</th>
    </tr>
    </thead>
<tbody>
{if isset($data.funds) && !empty($data.funds)}
{foreach $data.funds as $fund}
<tr>
    <td>{$fund.fund_type_name}</td>
    <td>¥{$fund.fund_amount}</td>
</tr>
{/foreach}
<tr class="info">
    <td><strong>合计</strong></td>
    <td><strong>¥{$data.declare_amount}</strong></td>
</tr>
{else}
<tr>
    <td colspan="2" class="text-center">暂无资金明细</td>
</tr>
{/if}
</tbody>
</table>
</div>
</div>
</div>
    <!-- /.box-body -->

    <div class="box-footer">
        {if $data.status == 0}
            <button type="button" class="btn btn-success" id="auditPassBtn">
                <i class="fa fa-check"></i> 审核通过
            </button>
            <button type="button" class="btn btn-danger" id="auditRejectBtn">
                <i class="fa fa-times"></i> 审核不通过
            </button>
        {/if}
        <a href="{:url('admin/DeclareRecord/index')}" class="btn btn-default">
            <i class="fa fa-arrow-left"></i> 返回
        </a>
    </div>
</div>
    <!-- /.box -->
</div>
    <!-- /.col -->
</div>
    <!-- /.row -->
</section>
<!-- /.content -->

    <script>
        $(document).ready(function () {
            // 审核通过
            $('#auditPassBtn').click(function () {
                layer.prompt({
                    title: '审核通过申报记录 #{$data.id}',
                    formType: 2,
                    area: ['500px', '150px'],
                    placeholder: '请输入审核备注（可选）',
                    value: '',
                    btn: ['确定通过', '取消']
                }, function (remark, index) {
                    layer.close(index);

                    layer.confirm('确定要通过此申报记录吗？', {
                        title: '确认审核',
                        icon: 3,
                        btn: ['确定', '取消']
                    }, function (confirmIndex) {
                        layer.close(confirmIndex);
                        submitAudit(1, remark);
                    });
                });
            });

            // 审核不通过
            $('#auditRejectBtn').click(function () {
                layer.prompt({
                    title: '审核不通过申报记录 #{$data.id}',
                    formType: 2,
                    area: ['500px', '150px'],
                    placeholder: '请输入审核不通过的原因',
                    value: '',
                    btn: ['确定不通过', '取消']
                }, function (remark, index) {
                    if (!remark.trim()) {
                        layer.msg('请填写审核不通过的原因', { icon: 2 });
                        return false;
                    }

                    layer.close(index);

                    layer.confirm('确定不通过此申报记录吗？', {
                        title: '确认审核',
                        icon: 3,
                        btn: ['确定', '取消']
                    }, function (confirmIndex) {
                        layer.close(confirmIndex);
                        submitAudit(2, remark);
                    });
                });
            });

            function submitAudit(status, remark) {
                var loadIndex = layer.load(2, { time: 10 * 1000 });

                $.ajax({
                    url: '{:url("admin/DeclareRecord/audit")}',
                    type: 'POST',
                    data: {
                        id: { $data.id },
                        status: status,
                        audit_remark: remark
                    },
                    dataType: 'json',
                    success: function (response) {
                        layer.close(loadIndex);
                        if (response.code === 200) {
                            layer.msg('审核成功！', { icon: 1, time: 1500 }, function () {
                                location.reload();
                            });
                        } else {
                            layer.msg('审核失败：' + response.msg, { icon: 2 });
                        }
                    },
                    error: function () {
                        layer.close(loadIndex);
                        layer.msg('网络错误，审核失败！', { icon: 2 });
                    }
                });
            }
        });
    </script>