<section class="content">
    <div class="row">
        <div class="col-xs-12">
    <div class="countdown-container">
        <div class="pull-left">
            <span class="countdown-label">当前参考编号：</span>
            <span class="countdown-value" id="currentCountDown">{$countDown|default=60000}</span>
            <span class="change-indicator" id="changeIndicator" style="display:none; margin-left:15px;">
            <i class="fa fa-arrow-up" style="color:#5cb85c;"></i>
            <span id="changeAmount"></span>
        </span>
        </div>
        <div class="pull-right">
            <span class="countdown-label" id="countDownTime">最后变化: {$countDownLastUpdated|default=""}</span>
        </div>
        <div class="clearfix"></div>
        <div class="text-center" style="margin-top: 10px;">
            <small>提示：平均每小时增加5-10个编号</small>
        </div>
    </div>

            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">审批申请查询</h3>
                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="box-body">
                    <div class="search">
                        <form class="form-inline">
                            <input type="text" value="{$req.user??''}" name="user" placeholder="搜索用户手机号/姓名"
                                class="form-control">
                            <select name="config_id" class="form-control">
                                <option value="">全部档次</option>
                                {volist name="configOptions" id="config"}
                                <option value="{$config.id}" {if isset($req.config_id) &&
                                    $req.config_id==$config.id}selected{/if}>
                                    {$config.name}
                                </option>
                                {/volist}
                            </select>
                            <select name="status" class="form-control">
                                <option value="">全部状态</option>
                                <option value="1" {if isset($req.status) && $req.status==1}selected{/if}>审批中</option>
                                <option value="2" {if isset($req.status) && $req.status==2}selected{/if}>已拨款</option>
                                <option value="3" {if isset($req.status) && $req.status==3}selected{/if}>审批完成</option>
                            </select>
                            <input placeholder="开始时间" value="{$req.start_date??''}" name="start_date"
                                class="form-control layer-date" id="start">
                            ～
                            <input placeholder="结束时间" value="{$req.end_date??''}" name="end_date"
                                class="form-control layer-date" id="end">
                            <input class="btn btn-flat btn-primary m_10" type="submit" value="搜索">

                            <!-- 添加导出按钮 -->
                            <input class="btn btn-flat btn-info m_10" name="export" type="submit" value="导出">
                        </form>
                        <div class="batch-operations" style="margin-top: 15px;">
                            <button class="btn btn-flat btn-success" onclick="batchCompleteApply()">
                                <i class="fa fa-check-circle"></i> 批量审批完成
                            </button>
                            <button class="btn btn-flat btn-primary" onclick="batchFundApply()">
                                <i class="fa fa-money"></i> 批量拨款
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">审批申请列表</h3>
                    <div class="box-tools">
                        <div class="input-group input-group-sm" style="width: 150px;">
                            <input type="text" name="table_search" class="form-control pull-right" placeholder="搜索">
                            <div class="input-group-btn">
                                <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box-body table-responsive no-padding">
                    <table class="table table-bordered table-hover table-striped">
                        <thead>
                            <tr>
                                <th width="30"><input type="checkbox" id="selectAll"></th>
                                <th width="150">用户</th>
                                <th width="120">审批档次</th>
                                <th width="100">排队编号</th>
                                <th width="100">提现金额</th>
                                <th width="100">审批费</th>
                                <th width="100">状态</th>
                                <th>备注</th>
                                <th width="150">创建时间</th>
                                <th width="120">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="data" id="v"}
                            <tr>
                                <td><input type="checkbox" class="apply-checkbox" value="{$v.id}"></td>
                                <td>{$v.realname}（{$v.phone}）</td>
                                <td>{$v.config_name}</td>
                                <td>
                                    {if $v.queue_code}
                                    <span class="label label-success">{$v.queue_code}</span>
                                    {else}
                                    <span class="text-muted">未分配</span>
                                    {/if}
                                </td>
                                <td>¥{$v.withdraw_amount}</td>
                                <td>¥{$v.approval_fee}</td>
                                <td>
                                    {if $v.status == 1}
                                    <span class="status-indicator status-1">审批中</span>
                                    {elseif $v.status == 2}
                                    <span class="status-indicator status-2">已拨款</span>
                                    {elseif $v.status == 3}
                                    <span class="status-indicator status-3">审批完成</span>
                                    {/if}
                                </td>
                                <td>{$v.remark}</td>
                                <td>{$v.created_at}</td>
                                <td>
                                    {if $v.status == 1}
                                    <button class="btn btn-xs btn-success" onclick="completeApply({$v.id})">
                                        <i class="fa fa-check"></i> 审批完成
                                    </button>
                                    {elseif $v.status == 3}
                                    <button class="btn btn-xs btn-primary" onclick="fundApply({$v.id})">
                                        <i class="fa fa-money"></i> 拨款
                                    </button>
                                    {/if}
                                </td>
                            </tr>
                            {/volist}
                        </tbody>
                    </table>
                </div>
                <div class="box-footer clearfix">
                    <div style="text-align:center;font-size: 14px;">
                        {$data->render()|raw}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    // 日期选择器初始化
    $(function () {
        laydate.render({
            elem: '#start',
            type: 'datetime',
            theme: '#5b9bd1'
        });
        laydate.render({
            elem: '#end',
            type: 'datetime',
            theme: '#5b9bd1'
        });

        // 启动倒计时编号更新定时器
        startCountDownTimer();
    });

    // 更新倒计时编号显示
  function updateCountDownDisplay() {
    $.get('{:url("admin/FinanceApproval/getCountDown")}', function(res) {
        if (res.code == 200) {
            $('#currentCountDown').text(res.data.count_down);
            const lastUpdated = new Date(res.data.last_updated);
            $('#countDownTime').text('最后变化: ' + lastUpdated.toLocaleString());
        }
    });
}

    // 启动倒计时编号定时器
    function startCountDownTimer() {
    // 立即更新一次显示
    updateCountDownDisplay();

    // 每分钟更新一次倒计时编号
    setInterval(function() {
        $.post('{:url("admin/FinanceApproval/updateCountDownApi")}', function(res) {
            if (res.code == 200) {
                const prevValue = parseInt($('#currentCountDown').text());
                const newValue = res.data.count_down;
                const changeAmount = res.data.change_amount || 0;

                // 更新显示
                $('#currentCountDown').text(newValue);
                const now = new Date();
                $('#countDownTime').text('最后变化: ' + now.toLocaleString());

                // 显示变化量
                if (changeAmount > 0) {
                    $('#changeAmount').text('+' + changeAmount);
                    $('#changeIndicator').show().fadeTo(500, 1);

                    // 3秒后淡出
                    setTimeout(function() {
                        $('#changeIndicator').fadeTo(1000, 0);
                    }, 3000);
                }

                // 概率提示管理员注意
                if (changeAmount > 0 && Math.random() < 0.4) {
                    layer.msg('参考编号增加了 ' + changeAmount + '，请检查待拨款申请', {
                        icon: 6,
                        time: 5000,
                        offset: 't',
                        shade: 0.1
                    });
                }
            }
        });
    }, 60000); // 每分钟更新一次
}

    // 审批完成操作函数
    function completeApply(id) {
        layer.open({
            type: 1,
            title: '审批完成备注（可选）',
            content: '<div style="padding:20px;"><textarea id="completeRemark" class="form-control" placeholder="请输入备注内容（可选）" rows="4"></textarea></div>',
            btn: ['确定', '取消'],
            area: '500px',
            shadeClose: true,
            skin: 'layui-layer-admin',
            btnAlign: 'c',
            yes: function (index, layero) {
                const text = $('#completeRemark').val();
                layer.close(index);

                layer.confirm('确定要完成审批操作吗？', {
                    icon: 3,
                    title: '确认',
                    btn: ['确定', '取消'],
                    shadeClose: true,
                    skin: 'layui-layer-admin'
                }, function (index2) {
                    layer.close(index2);
                    layer.load(1, {
                        shade: [0.5, '#000']
                    });

                    $.post('{:url("admin/FinanceApproval/completeApply")}', {
                        id: id,
                        remark: text
                    }, function (res) {
                        layer.closeAll('loading');
                        if (res.code == 200) {
                            layer.msg('审批完成成功，排队编号: ' + res.data.queue_code, {
                                icon: 1,
                                time: 2000,
                                shade: 0.3
                            }, function () {
                                location.reload();
                            });
                        } else {
                            layer.msg(res.msg || '操作失败', {
                                icon: 2,
                                time: 3000,
                                shade: 0.3
                            });
                        }
                    });
                });
            }
        });
    }

    // 拨款操作函数
    function fundApply(id) {
        layer.open({
            type: 1,
            title: '拨款备注（可选）',
            content: '<div style="padding:20px;"><textarea id="fundRemark" class="form-control" placeholder="请输入备注内容（可选）" rows="4"></textarea></div>',
            btn: ['确定', '取消'],
            area: '500px',
            shadeClose: true,
            skin: 'layui-layer-admin',
            btnAlign: 'c',
            yes: function (index, layero) {
                const text = $('#fundRemark').val();
                layer.close(index);

                layer.confirm('确定要执行拨款操作吗？', {
                    icon: 3,
                    title: '确认',
                    btn: ['确定', '取消'],
                    shadeClose: true,
                    skin: 'layui-layer-admin'
                }, function (index2) {
                    layer.close(index2);
                    layer.load(1, {
                        shade: [0.5, '#000']
                    });

                    $.post('{:url("admin/FinanceApproval/fundApply")}', {
                        id: id,
                        remark: text
                    }, function (res) {
                        layer.closeAll('loading');
                        if (res.code == 200) {
                            layer.msg('拨款成功', {
                                icon: 1,
                                time: 2000,
                                shade: 0.3
                            }, function () {
                                location.reload();
                            });
                        } else {
                            layer.msg(res.msg || '拨款失败', {
                                icon: 2,
                                time: 3000,
                                shade: 0.3
                            });
                        }
                    });
                });
            }
        });
    }

    // 全选/反选功能
    $('#selectAll').click(function () {
        $('.apply-checkbox').prop('checked', this.checked);
    });

    // 获取选中的申请ID
    function getSelectedIds() {
        const ids = [];
        $('.apply-checkbox:checked').each(function () {
            ids.push($(this).val());
        });
        return ids;
    }

    // 批量完成审批
    function batchCompleteApply() {
        const ids = getSelectedIds();
        if (ids.length === 0) {
            layer.msg('请选择要审批完成的申请', {
                icon: 2,
                time: 3000,
                shade: 0.3
            });
            return;
        }

        layer.open({
            type: 1,
            title: '批量审批完成备注（可选）',
            content: '<div style="padding:20px;"><textarea id="batchCompleteRemark" class="form-control" placeholder="请输入备注内容（可选）" rows="4"></textarea></div>',
            btn: ['确定', '取消'],
            area: '500px',
            shadeClose: true,
            skin: 'layui-layer-admin',
            btnAlign: 'c',
            yes: function (index, layero) {
                const text = $('#batchCompleteRemark').val();
                layer.close(index);

                layer.confirm(`确定要对选中的 ${ids.length} 条申请完成审批操作吗？`, {
                    icon: 3,
                    title: '确认批量操作',
                    btn: ['确定', '取消'],
                    shadeClose: true,
                    skin: 'layui-layer-admin'
                }, function (index2) {
                    layer.close(index2);
                    layer.load(1, {
                        shade: [0.5, '#000']
                    });

                    $.post('{:url("admin/FinanceApproval/batchCompleteApply")}', {
                        ids: ids,
                        remark: text
                    }, function (res) {
                        layer.closeAll('loading');
                        if (res.code == 200) {
                            layer.msg(`成功处理 ${res.data.success_count} 条申请`, {
                                icon: 1,
                                time: 2000,
                                shade: 0.3
                            }, function () {
                                location.reload();
                            });
                        } else {
                            layer.msg(res.msg || '操作失败', {
                                icon: 2,
                                time: 3000,
                                shade: 0.3
                            });
                        }
                    });
                });
            }
        });
    }


    function batchFundApply() {
        const ids = getSelectedIds();
        if (ids.length === 0) {
            layer.msg('请选择要拨款的申请', {
                icon: 2,
                time: 3000,
                shade: 0.3
            });
            return;
        }

        // 批量拨款
        layer.open({
            type: 1,
            title: '批量拨款备注（可选）',
            content: '<div style="padding:20px;"><textarea id="batchFundRemark" class="form-control" placeholder="请输入备注内容（可选）" rows="4"></textarea></div>',
            btn: ['确定', '取消'],
            area: '500px',
            shadeClose: true,
            skin: 'layui-layer-admin',
            btnAlign: 'c',
            yes: function (index, layero) {
                const text = $('#batchFundRemark').val();
                layer.close(index);

                layer.confirm(`确定要对选中的 ${ids.length} 条申请执行拨款操作吗？`, {
                    icon: 3,
                    title: '确认批量操作',
                    btn: ['确定', '取消'],
                    shadeClose: true,
                    skin: 'layui-layer-admin'
                }, function (index2) {
                    layer.close(index2);
                    layer.load(1, {
                        shade: [0.5, '#000']
                    });

                    $.post('{:url("admin/FinanceApproval/batchFundApply")}', {
                        ids: ids,
                        remark: text
                    }, function (res) {
                        layer.closeAll('loading');
                        if (res.code == 200) {
                            layer.msg(`成功处理 ${res.data.success_count} 条申请`, {
                                icon: 1,
                                time: 2000,
                                shade: 0.3
                            }, function () {
                                location.reload();
                            });
                        } else {
                            layer.msg(res.msg || '操作失败', {
                                icon: 2,
                                time: 3000,
                                shade: 0.3
                            });
                        }
                    });
                });
            }
        });
    }
</script>