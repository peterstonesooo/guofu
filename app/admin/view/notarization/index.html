<div class="search">
    <form class="form-inline">
        <input type="text" value="{$req['user']??''}" name="user" placeholder="搜索用户ID/手机号" class="form-control">
        <select name="status" class="form-control">
            <option value="">搜索状态</option>
            <option value="0" {isset($req['status']) && $req['status']==='0'?'selected':''}>待公证</option>
            <option value="1" {isset($req['status']) && $req['status']==='1'?'selected':''}>公证中</option>
            <option value="2" {isset($req['status']) && $req['status']==='2'?'selected':''}>完成公证</option>
        </select>
        <input placeholder="开始时间" autocomplete="off" value="{$req['start_date']??''}" name="start_date" class="form-control layer-date" id="start">
        ～
        <input placeholder="结束时间" autocomplete="off" value="{$req['end_date']??''}" name="end_date" class="form-control layer-date" id="end">
        
        <input class="btn btn-flat btn-primary m_10" type="submit" value="搜索">
        <input class="btn btn-flat btn-info m_10" name="export" type="submit" value="导出">
        <button type="button" class="btn btn-flat btn-success m_10" id="batchApprove">批量通过</button>
    </form>
</div>

<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-header">
                <h3 class="box-title">公证管理列表</h3>
                <div class="box-tools">
                    <span class="label label-info">总金额: {$total_money}</span>
                    <span class="label label-warning">总手续费: {$total_fees}</span>
                </div>
            </div>
            <div class="box-body table-responsive no-padding">
                <table class="table table-bordered table-hover table-striped">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="checkAll"></th>
                        <th>ID</th>
                        <th>用户手机</th>
                        <th>用户姓名</th>
                        <th>金额</th>
                        <th>手续费</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>完成时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <?php foreach ($data as $k => $v) { ?>
                        <tr>
                            <td>
                                <?php if($v['status'] == 1) { ?>
                                    <input type="checkbox" class="check-item" value="{$v['id']}">
                                <?php } ?>
                            </td>
                            <td>{$v['id']}</td>
                            <td>{$v['phone']}</td>
                            <td>{$v['realname']}</td>
                            <td class="text-danger">￥{$v['money']}</td>
                            <td class="text-warning">￥{$v['fees']}</td>
                            <td>
                                <span class="label label-{$v['status_color']}">{$v['status_text']}</span>
                            </td>
                            <td>{$v['created_at']}</td>
                            <td>{$v['end_time']??'-'}</td>
                            <td>
                                <?php if($v['status'] == 1) { ?>
                                    <button class="btn btn-success btn-xs btn-approve" data-id="{$v['id']}">审核通过</button>
                                <?php } else { ?>
                                    -
                                <?php } ?>
                            </td>
                        </tr>
                    <?php } ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-sm-5">
        <div class="dataTables_info" id="example2_info" role="status" aria-live="polite">
            共 {$data->total()} 条记录
        </div>
    </div>
    <div class="col-sm-7">
        <div class="dataTables_paginate paging_simple_numbers">
            {$data->render()|raw}
        </div>
    </div>
</div>

<script>
// 时间选择器
laydate.render({
    elem: '#start',
    type: 'date'
});

laydate.render({
    elem: '#end',
    type: 'date'
});

// 全选/反选
$('#checkAll').on('change', function() {
    $('.check-item').prop('checked', $(this).prop('checked'));
});

// 单个审核通过
$('.btn-approve').on('click', function() {
    var id = $(this).data('id');
    layer.confirm('确定要审核通过该公证记录吗？', {
        btn: ['确定', '取消']
    }, function() {
        $.post('{:url("notarization/approve")}', {id: id}, function(res) {
            if (res.code == 1) {
                layer.msg(res.msg, {icon: 1}, function() {
                    location.reload();
                });
            } else {
                layer.msg(res.msg, {icon: 2});
            }
        }, 'json');
    });
});

// 批量审核通过
$('#batchApprove').on('click', function() {
    var ids = [];
    $('.check-item:checked').each(function() {
        ids.push($(this).val());
    });
    
    if (ids.length == 0) {
        layer.msg('请选择要审核的记录', {icon: 2});
        return;
    }
    
    layer.confirm('确定要批量审核通过这 ' + ids.length + ' 条记录吗？', {
        btn: ['确定', '取消']
    }, function() {
        $.post('{:url("notarization/batchApprove")}', {ids: ids}, function(res) {
            if (res.code == 1) {
                layer.msg(res.msg, {icon: 1}, function() {
                    location.reload();
                });
            } else {
                layer.msg(res.msg, {icon: 2});
            }
        }, 'json');
    });
});
</script>