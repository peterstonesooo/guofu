<div class="search">
    <form class="form-inline">
        <input type="text" value="{$req['user']??''}" name="user" placeholder="搜索用户ID/手机号" class="form-control">
        <input type="text" value="{$req['realname']??''}" name="realname" placeholder="搜索实名" class="form-control">
        <select name="status" class="form-control">
            <option value="">搜索状态</option>
            <?php foreach (config('map.realname_status') as $k => $v) { ?>
                <option <?php if (isset($req['status']) && $req['status']!='' && $req['status'] == $k) {
                    echo 'selected = "selected"';
                } ?> value="{$k}">{$v}
                </option>
            <?php } ?>
        </select>
    

        <input placeholder="开始时间" autocomplete="off" value="{$req['start_date']??date('Y-m-d',strtotime('-7 day'))}" name="start_date" class="form-control layer-date" id="start">
        ～
        <input placeholder="结束时间" autocomplete="off" value="{$req['end_date']??''}" name="end_date" class="form-control layer-date" id="end">
        <input class="btn btn-flat btn-primary m_10" type="submit" value="搜索">
        <?php if (!empty($req['status']) && $req['status'] == 1) { ?>
<!--             <input class="btn btn-flat btn-success m_10" type="button" value="批量审核通过" onclick="batchauditRealname(1)">
            <input class="btn btn-flat btn-warning m_10" type="button" value="批量审核拒绝" onclick="batchauditRealname(2)">
 -->        <?php } ?>

    </form>
</div>

<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-header">
                <div class="box-body table-responsive no-padding">
                    <table class="table table-bordered table-hover table-striped">
                        <tbody>
                        <tr>
                            <?php if (!empty($req['status']) && in_array($req['status'], [1, 4])) { ?>
                            <th><input id="batch_selected" type="checkbox" onclick="batch_selected()"></th>
                            <?php } ?>
                            <th>ID</th>
                            <th>用户ID</th>
                            <th>电话</th>
                            <th>状态</th>
                            <th>姓名</th>
                            <th>身份证号</th>
                            <th>正面</th>
                            <th>反面</th>
                            <th>审核用户</th>
                            <th>拒绝理由</th>
                            <th>审核时间</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                        <?php foreach ($data as $k => $v) { ?>
                            <tr>
                                <?php if (!empty($req['status']) && in_array($req['status'], [0])) { ?>
                                <td><input id="order_id_{$v['id']}" class="order_ids" type="checkbox" value="{$v['id']}"></td>
                                <?php } ?>
                                <td>{$v['id']}</td>
                                <td>{$v['user_id']}</td>
                                <td>{$v['phone']}</td>
                                <td>{$v['status_text']}</td>
                                <td>
                                    {$v['realname']}
                                </td>
                                <td>{$v['ic_number']}</td>
                                <td><img src="{$v['img1']}" onclick="seePhoto('{$v['img1']}')" style="max-width: 80px;"></td>
                                <td><img src="{$v['img2']}" onclick="seePhoto('{$v['img2']}')" style="max-width: 80px;"></td>
                                
                                <td>{$v['admin_name']}</td>
                                <td>{$v['mark']}</td>
                                <td>{$v['audit_time']}</td>
                                <td>{$v['created_at']}</td>
                                <td>
                                       {if($v['status']==0)} 
                                       <button  class="btn btn-flat btn-success btn-xs" onclick="auditRealname(<?php echo $v['id'] ?>,1)">审核通过</button>
                                        <button  class="btn btn-flat btn-warning btn-xs" onclick="auditRealname(<?php echo $v['id'] ?>,2)">审核拒绝</button>
                                    {/if}
                                </td>
                            </tr>
                        <?php } ?>

                        </tbody>
                    </table>
                </div>
                <div style="text-align:center;font-size: 14px;"><?php echo $data->render(); ?></div>
            </div>
        </div>
    </div>
</div>

<script>
    function batch_selected()
    {
        if ($('#batch_selected').is(':checked')) {
            $(".order_ids").attr("checked", "true");
        }
        else {
            $(".order_ids").removeAttr("checked");
        }
    }

    $(function () {
        //日期范围限制
        var start = {
            elem: '#start',
            format: 'yyyy-MM-dd',
        };
        var end = {
            elem: '#end',
            format: 'yyyy-MM-dd',
        };
        laydate.render(start);
        laydate.render(end);
    });

    function batchauditRealname(status)
    {
        layer.confirm('确定操作吗？', {icon: 3, title: '提示'}, function (index) {
            layer.close(index);
            layer.load();
            let order_ids = [];
            $.each($('.order_ids'), function(){
                if (this.checked) {
                    order_ids.push($(this).val());
                }
            });
            $.post('{:url("admin/Realname/batchauditRealname")}', {ids: order_ids, status: status}, function (res) {
                if (res.code == '200') {
                    location.reload(true);
                } else {
                    layer.closeAll("loading");
                    alert(res.msg);
                    // layer.msg(res.msg, {icon: 5, time: 3000});
                    location.reload(true);
                }
            });
        });
    }

    function auditRealname(id, status)
    {
        if (status == 2) {
            layer.prompt({title: '拒绝理由', formType: 2}, function(text, index){
                layer.close(index);
                $.post('{:url("admin/Realname/audit")}', {id: id, status: status, audit_remark:text}, function (res) {
                    if (res.code == '200') {
                        location.reload(true);
                    } else {
                        layer.msg(res.msg, {icon: 5, time: 3000});
                    }
                });
            });
        }
        else {
            layer.confirm('确定操作吗？', {icon: 3, title: '提示'}, function (index) {
                layer.close(index);
                layer.load();
                $.post('{:url("admin/Realname/audit")}', {id: id, status: status,audit_remark:''}, function (res) {
                    if (res.code == '200') {

                            location.reload(true);
                        
                    } else {
                        layer.closeAll("loading");
                        layer.msg(res.msg, {icon: 5, time: 3000});
                    }
                });
            });
        }
    }


</script>
