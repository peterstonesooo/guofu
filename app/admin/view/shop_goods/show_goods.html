<link  rel="stylesheet" href="__ADMIN__/bower_components/layui/css/layui.css">
<script src="__ADMIN__/bower_components/layui/layui.js"></script>

    <div style="padding: 0 20px;position: relative;z-index: 99;border-bottom: 1px solid #e5e5e5;line-height: 39px;height: 39px;overflow: hidden;">
          <span style="visibility: visible;">
            <a href="{:url('/admin/ShopGoods/goodsList')}" style="padding-right: 8px;line-height: 22px;font-size: 14px;color: #333!important;">商品管理<span class="layui-box">&gt;</span></a>
            <a href="javascript:;"> <cite>商品</cite></a>
          </span>
    </div>
    <style>
    #demo2 img{margin-right:10px;}
    .layui-upload-list .p{
      margin-right: 25px;
      width: 200px;
      position: relative;
      height: 135px;
      margin-top: 15px;
      overflow: hidden;
      float: left;
    }
    .layui-upload-list .p img{
      width: 100%;
      height: 100%;
    }
    .layui-upload-list .p .weiz{
      position: absolute;
      bottom: 0px;
      width: 100%;
      height: 25px;
      display: flex;
      justify-content: space-around;
      background: rgb(0, 0, 0,0.8);
      line-height: 25px;
    }
    .layui-upload-list .p .weiz a{
      color: #ffffff;
    }
    .layui-upload-list .p .weiz a:nth-child(2)
    {
      color:red
    }
    .layui-form-label{
      width: 100px;
    }
    </style>
    <div class="layui-fluid">
        <div class="layui-row layui-col-space15">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-body">
                        <form onsubmit="return false;">
                            <div class="layui-form" wid100 lay-filter="">
                                  <div class="layui-field-box" style="padding-left: 55px;">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">商品名称</label>
                                        <div class="layui-input-inline">
                                            <input type="hidden" value="{$data['id']??0}" name="id">
                                            <input type="text" name="title" lay-verify="required" placeholder="请输入名称" class="layui-input" value="{$data['title']??''}">
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">所属分类</label>
                                        <div class="layui-input-inline">
                                            <select name="cate_id" lay-verify="">
                                                <option  value="">--请选择--</option>
                                                {foreach($cate as $item)}
                                                    <option value="{$item.id}" {if(isset($data['cate_id']) && $data['cate_id'] == $item['id'])} selected {/if}>{$item.title}</option>
                                                {/foreach}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">封面图</label>
                                        <div class="layui-input-inline">
                                            <div class="layui-progress" id="progress_imgurl" lay-filter="progress_imgurl" lay-showPercent="true" style="display: none;margin-bottom:10px">
                                                <div class="layui-progress-bar layui-bg-red" lay-percent="0%"></div>
                                            </div>
                                            <input type="hidden" name="imgurl" value="{$data['imgurl']??''}" lay-verify="required" placeholder="请上传图片" autocomplete="off" class="layui-input" >
                                            <img style="float:left;width:120px;" class="" id="imgurl" src="{$data['img_url'] ?? '/admin/img/upload.jpg'}">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">提示：图片尺寸比例为：750:216，建议最大不超过1M，格式为：.jpg，.jpeg，.png</div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">商品轮播图</label>
                                        <div class="layui-input-block">
                                            <div class="layui-upload">
                                              <button type="button" class="layui-btn" id="test1">多图片上传</button> 
                                              <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;overflow:hidden">
                                                预览图：
                                                <div class="layui-upload-list" id="demo1">
                                                    {if(isset($data['imgs_list']) && !empty($data['imgs_list']))}
                                                    {foreach($data['imgs_list'] as $img)}
                                                    <div class="p" onclick="deldom(this)">
                                                        <img src="{$img['imgurl']}" class="layui-upload-img">
                                                        <input type="hidden" name="imgs[]" value="{$img.id}">
                                                        <div class="weiz">
                                                            <a onclick="leftimg(this)">前移</a>
                                                            <a onclick="delimg(this)">删除</a>
                                                            <a onclick="rightimg(this)">后移</a>
                                                        </div>
                                                    </div>
                                                    {/foreach}
                                                    {/if}
                                                </div>
                                             </blockquote>
                                            </div>
                                        </div>
                                        <div class="layui-form-mid layui-word-aux" style="margin-left:140px">提示：图片尺寸比例为：750:216，建议最大不超过1M，格式为：.jpg，.jpeg，.png</div>
                                    </div>
                                   <div class="layui-form-item">
                                        <label class="layui-form-label">原价格</label>
                                        <div class="layui-input-inline">
                                            <input type="number" name="old_price" value="{$data['old_price']??0}" min="0"  lay-verify="required" placeholder="请输入原价格" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">现价格</label>
                                        <div class="layui-input-inline">
                                            <input type="number" name="price" value="{$data['price']??0}" min="0"  lay-verify="required" placeholder="请输入价格" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">所需积分</label>
                                        <div class="layui-input-inline">
                                            <input type="number" name="integral" value="{$data['integral']??0}" min="0"  lay-verify="required" placeholder="请输入所需积分" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">总库存</label>
                                        <div class="layui-input-inline">
                                            <input type="number" name="num" value="{$data['num']??0}" min="0" step="1" lay-verify="required" placeholder="请输入总库存" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">已购数量</label>
                                        <div class="layui-input-inline">
                                            <input type="number" name="sale_num" value="{$data['sale_num']??0}" min="0" step="1" lay-verify="required" placeholder="请输入已购数量" class="layui-input">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">提示：虚拟销售数量</div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">限购数量</label>
                                        <div class="layui-input-inline">
                                            <input type="number" name="limitnum" value="{$data['limitnum']??0}" min="0" step="1" lay-verify="required" placeholder="请输入限购数量" class="layui-input">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">提示：0为不限购</div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">规格</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="sku" value="{$data['sku']??''}" lay-verify="" placeholder="请输入规格" class="layui-input">
                                        </div>
                                        <div class="layui-form-mid layui-word-aux">提示：输入规格以“|”分割，如： 白色|红色|黑色</div>
                                    </div>
                                    
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">商品详情</label>
                                        <div class="layui-input-block">
                                            <div id="editor">
                                            </div>
                                        </div>
                                    </div>
<!--                                     <div class="layui-form-item">
                                        <label class="layui-form-label">评论数</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="comments" lay-verify="required" placeholder="直接输入文字如：999+" class="layui-input">
                                        </div>
                                    </div> -->
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">排序</label>
                                        <div class="layui-input-inline">
                                            <input type="number" name="sort" value="{$data['sort']??0}" lay-verify="required" placeholder="请输入排序(越大越靠前)" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">是否推荐</label>
                                        <div class="layui-input-block">
                                            <input type="radio" name="is_tuijian" value="0" checked lay-verify="required" title="否" class="layui-input" {if(isset($data['is_tuijian']) && $data['is_tuijian']==0)} checked {/if}>
                                            <input type="radio" name="is_tuijian" value="1" lay-verify="required" title="是" class="layui-input" {if(isset($data['is_tuijian']) && $data['is_tuijian']==1)} checked {/if}>
                                           
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">状态</label>
                                        <div class="layui-input-block">
                                            <input type="radio" name="status" value="0" lay-verify="required" title="下架" class="layui-input" {if(isset($data['status']) && $data['status']==0)} checked {/if}>
                                            <input type="radio" name="status" value="1" checked lay-verify="required" title="上架" class="layui-input" {if(isset($data['status']) && $data['status']==0)} checked {/if}>
                                           
                                        </div>
                                    </div>
                                    
                                        </div>
                                    </fieldset>
                                 <input type="hidden" name="infos" id="infos" value=""> 
                                <div class="layui-form-item">
                                    <div class="layui-input-block" style="margin-left:450px">
                                        <button class="layui-btn" onclick="return check()">确认保存</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="contents_edit" style="display:none">{if(isset($data['infos']))}{$data.infos|raw}{/if}</div>

    <script type="text/javascript" src="__ADMIN__/bower_components/wangeditor3/xss.js"></script>
    <script type="text/javascript" src="__ADMIN__/bower_components/wangeditor3/wangEditor.js"></script>
    <script type="text/javascript">
        uploadUrl = "{:url('/common/uploadShop')}";
        //uploadUrl = "{:url('/admin/common/uploadShop')}";

        var content = $("#contents_edit").html();
        var E = window.wangEditor
        var editor= new E('#editor')
        editor.customConfig.uploadImgServer = uploadUrl
        editor.customConfig.uploadImgHooks = {
                // 如果服务器端返回的不是 {errno:0, data: [...]} 这种格式，可使用该配置
                // （但是，服务器端返回的必须是一个 JSON 格式字符串！！！否则会报错）
                customInsert: function (insertImg, result, editor) {
                   // console.log(result);
                    // 图片上传并返回结果，自定义插入图片的事件（而不是编辑器自动插入图片！！！）
                    // insertImg 是插入图片的函数，editor 是编辑器对象，result 是服务器端返回的结果
            
                    // 举例：假如上传图片成功后，服务器端返回的是 url:'....' 这种格式，即可这样插入图片：
                    for(var i=0;i<result.data.url.length;i++){
                          var url = result.data.url[i]
                        insertImg(url)
                    }
            
                    // result 必须是一个 JSON 格式字符串！！！否则报错
                }
                
            }
        editor.customConfig.debug = true
        editor.create()
        if(content != ''){
            editor.txt.html(content);
        }
    </script>
    <script type="text/javascript">
        layui.use(['layer','form','upload','element'], function(){
            var $ = layui.$;
            var upload = layui.upload;
            var element = layui.element;
            //执行实例
            var uploadInst = upload.render({
                accept:'images'
                ,elem: '#imgurl' //绑定元素
                ,exts:"jpg|png|jpeg|webp|avif"
                ,url: uploadUrl //上传接口
                ,progress: function(n, elem){
                    $("#progress_imgurl").show();
                    var percent = n + '%' //获取进度百分比
                    element.progress('progress_imgurl', percent); //可配合 layui 进度条元素使用
                }
                ,done: function(res){
                    //上传完毕回调
                    if(res.code == 200){ //成功
                        layer.msg("上传成功",{icon:1,time:1000},function(){
                            $("#imgurl").attr("src",res.data.url);  //单图
                            $("input[name=imgurl]").val(res.data.id);
                            element.progress('progress_imgurl', '0%');
                            $("#progress_imgurl").css('display','none');
                        });
                    }else{ //失败
                        layer.msg(res.msg,{icon:2,anim:6,time:1500});
                    }
                }
                ,error: function(){
                    //请求异常回调
                    layer.msg('服务繁忙，请稍后再试',{icon:2,anim:6,time:1500});
                }
            });
             var uploadInst2 = upload.render({
                accept:'icon'
                ,elem: '#icon' //绑定元素
                ,url: uploadUrl //上传接口
                ,progress: function(n, elem){
                    $("#progress_imgurl2").show();
                    var percent = n + '%' //获取进度百分比
                    element.progress('progress_imgurl2', percent); //可配合 layui 进度条元素使用
                }
                ,done: function(res){
                    //上传完毕回调
                    if(res.code == 200){ //成功
                        layer.msg("上传成功",{icon:1,time:1000},function(){
                            $("#icon").attr("src",res.data.url);  //单图
                            $("input[name=icon]").val(res.data.id);
                            element.progress('progress_imgurl2', '0%');
                            $("#progress_imgurl2").css('display','none');
                        });
                    }else{ //失败
                        layer.msg(res.msg,{icon:2,anim:6,time:1500});
                    }
                }
                ,error: function(){
                    //请求异常回调
                    layer.msg('服务繁忙，请稍后再试',{icon:2,anim:6,time:1500});
                }
            });
                //多图片上传
          upload.render({
                elem: '#test1'
                ,url: uploadUrl //此处配置你自己的上传接口即可
                ,multiple: true
                ,before: function(res){
                }
                ,done: function(res){
                  //上传完毕
                  var imglist = '<div class="p" onclick="deldom(this)">';
                        imglist += '<img src="'+ res.data.url +'" class="layui-upload-img">';
                         imglist +='<input type="hidden" name="imgs[]" value="'+res.data.id+'">';
                        imglist += '<div class="weiz">';
                           imglist += '<a onclick="leftimg(this)">前移</a>';
                            imglist += '<a onclick="delimg(this)">删除</a>';
                            imglist += '<a onclick="rightimg(this)">后移</a>';
                        imglist += '</div>';
                    imglist += '</div>';
                    $('#demo1').append(imglist);
                }
              });
            
        });
       function leftimg(obj){
        var o = $(obj).parent().parent();
        if( o.prev().length > 0) {
          var tmp = o.clone();
          var oo = o.prev();
          o.remove();
          oo.before(tmp);
       }else{
        alert("已经是第一个了"); 
       }
    }
    function rightimg(obj){
        var o = $(obj).parent().parent();
       if( o.next().length > 0) {
          var tmp = o.clone();
          var oo = o.next();
          o.remove();
          oo.after(tmp);
       }else{
        alert("已经是最后一个了"); 
       }
    }
    function delimg(obj){
        layer.confirm('您确定要删除该图片吗？', {
              btn: ['确定','取消'] //按钮
            }, function(){
              var o = $(obj).parent().parent();
              o.remove();
              layer.closeAll();
            });
    }
      
        function check(){
            var html = editor.txt.html()
            //console.log(html)
            var contents = filterXSS(html, {
                 onIgnoreTagAttr: function (tag, name, value, isWhiteAttr) {
                    if (name.substr(0, 5) === 'style') {
                      // 通过内置的escapeAttrValue函数来对属性值进行转义
                      return name + '="' + filterXSS.escapeAttrValue(value) + '"';
                    }
                  }
            });
            
            var url="<?php echo !empty($data) ? url("admin/ShopGoods/editGoods") : url("admin/ShopGoods/addGoods");?>";
            var $ = layui.$;
            $("#infos").val(contents);
            var load=layer.load(2);
            $.post(url,$("form").serialize(),function(data){
                if(data.code==200){
                    layer.msg(data.msg,{icon:1,time:1000},function(){
                        window.location.href = document.referrer;;
                    });
                }else{
                    layer.msg(data.msg,{icon:2,anim:6,time:1500},function(){
                        layer.close(load);
                    });
                }
            })
        }
    </script>
    